{% extends "base.html" %}

{% from "form_helpers.html" import flashed_messages %}

{% block title %}
View Client - Account Ease
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2>View Client</h2>
  {{ flashed_messages() }}
  <div class="card mb-4"></div>
    <div class="card-body">
      <h5 class="card-title">{{ client.name }}</h5>
      <p class="card-text"><strong>Email:</strong> {{ client.email }}</p>
      <p class="card-text"><strong>Phone:</strong> {{ client.phone }}</p>
      <p class="card-text"><strong>Address:</strong> {{ client.address }}</p>
      <p class="card-text"><strong>Created At:</strong> {{ client.created_at }}</p>
      <a href="{{ url_for('client.update_client', client_id=client.id) }}" class="btn btn-primary">Edit</a>
      <button type="button" 
              class="btn btn-danger" 
              data-bs-toggle="modal" 
              data-bs-target="#deleteClientModal">
        <i class="bi bi-trash me-2"></i>Delete Client
      </button>
    </div>
  </div>

  <div class="mb-4">
    <h3>Projects</h3>
    <a href="{{ url_for('project.create_project') }}" class="btn btn-success mb-3">Create Project</a>
    {% if client.projects %}
      <ul class="list-group">
        {% for project in client.projects %}
          <li class="list-group-item">
            <a href="{{ url_for('project.view_project', prj_id=project.id) }}">{{ project.title }}</a>
            <p class="mb-0"><strong>Start Date:</strong> {{ project.start_date }}</p>
            <p class="mb-0"><strong>End Date:</strong> {{ project.end_date }}</p>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">No projects found for this client.</p>
    {% endif %}
  </div>

  <div>
    <h3>Invoices</h3>
    {% if client.invoices %}
      <ul class="list-group">
        {% for invoice in client.invoices %}
          <li class="list-group-item">
            <a href="{{ url_for('invoice.view_invoice', id=invoice.id) }}">Invoice #{{ invoice.id }}</a>
            <p class="mb-0"><strong>Date:</strong> {{ invoice.date }}</p>
            <p class="mb-0"><strong>Amount:</strong> ${{ "%.2f"|format(invoice.amount) }}</p>
            <p class="mb-0"><strong>Status:</strong> {{ invoice.status.value }}</p>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted">No invoices found for this client.</p>
    {% endif %}
  </div>
</div>

<!-- Delete Client Modal -->
<div class="modal fade" id="deleteClientModal" tabindex="-1" aria-labelledby="deleteClientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteClientModalLabel">Delete Client</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this client?</p>
        <p class="text-danger"><strong>This action cannot be undone.</strong></p>
        <p><strong>Client Details:</strong></p>
        <ul>
          <li>Name: {{ client.name }}</li>
          <li>Email: {{ client.email }}</li>
          <li>Phone: {{ client.phone or 'Not provided' }}</li>
        </ul>
        <p class="text-warning"><strong>Warning:</strong> This will also delete all associated projects and invoices.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="deleteClient({{ client.id }})">
          Delete Client
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteClient(clientId) {
  // Show loading state
  const deleteBtn = document.querySelector('#deleteClientModal .btn-danger');
  const originalText = deleteBtn.innerHTML;
  deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
  deleteBtn.disabled = true;
  
  // Send DELETE request
  fetch(`/client/${clientId}/delete`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(response => {
    if (response.ok) {
      // Success - close modal and redirect
      const modal = bootstrap.Modal.getInstance(document.getElementById('deleteClientModal'));
      modal.hide();
      
      // Show success message and redirect
      window.location.href = '{{ url_for("client.index") }}';
    } else if (response.status === 403) {
      // Unauthorized - Flask will show the 403 error page
      // We just need to close the modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('deleteClientModal'));
      modal.hide();
      // The page will show the 403 error page
    } else {
      throw new Error('Failed to delete client');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    // Reset button state
    deleteBtn.innerHTML = originalText;
    deleteBtn.disabled = false;
    
    // Only show alert for network errors, not HTTP errors
    if (error.name === 'TypeError') {
      alert('Network error. Please try again.');
    }
  });
}
</script>
{% endblock %}